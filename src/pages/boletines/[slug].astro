---
// Shadcn UI components
import {
    Breadcrumb,
    BreadcrumbItem,
    BreadcrumbLink,
    BreadcrumbList,
    BreadcrumbPage,
    BreadcrumbSeparator,
} from "@/components/ui/breadcrumb";

import {PostService} from "../../core/services";
import {marked} from "marked";
import readingTime from "reading-time";
import BlogLayout from "@/layouts/BlogLayout.astro";

export const prerender = false;
const { slug } = Astro.params;

if (!slug) {
    throw new Error("Missing slug param");
}

// Usas directamente el servicio (ya crea el repo internamente)
const service = new PostService();
const post = await service.getPostBySlug(slug!);

if (!post) {
    throw new Error("Not found");
}

const stats = readingTime(post.content);
const readingTimeText =
    stats.minutes < 1
        ? "Menos de 1 minuto de lectura"
        : `${Math.ceil(stats.minutes)} minuto${Math.ceil(stats.minutes) > 1 ? "s" : ""} de lectura`;


// Markdown → HTML
const htmlContent = marked.parse(post.content);
---

<BlogLayout title={post.title} description={post.title}>
    <main class="mx-auto max-w-6xl px-6 lg:px-8 py-12 sm:py-16">
        <section
                class={`relative w-full h-80 flex items-center justify-center text-center ${
                    post.coverUrl ? "" : "bg-gradient-to-b from-gray-50 to-gray-100"
                }`}
                aria-label={post.title}
        >
            {post.coverUrl && (
                    <>
                        <img
                                src={post.coverUrl}
                                alt="Cover"
                                class="absolute inset-0 w-full h-full object-cover"
                        />
                        <div class="absolute inset-0 bg-gradient-to-b from-neutral-900/70 via-neutral-600/60 to-red-600/30"></div>
                    </>
            )}

            <!-- Autor + categorías en esquina inferior izquierda -->
            <div class="absolute bottom-4 left-4 flex flex-col gap-2 text-sm max-w-[45%] sm:max-w-none">
                <div class="flex items-center gap-3 px-3 py-2 text-left">
                    <!-- Avatar / Foto -->
                    <div class="rounded-full bg-red-500 w-8 h-8 sm:w-11 sm:h-11 flex items-center justify-center text-white font-bold text-xs sm:text-base flex-shrink-0">
                        {post.author ? post.author.firstLastname[0] + (post.author.secondLastname?.[0] || "") : "?"}
                    </div>
                    <!-- Nombre y tiempo de lectura -->
                    <div class="flex flex-col justify-center items-start gap-1 min-w-0 flex-1">
                        <p class="text-gray-600 text-xs font-medium truncate w-full hidden sm:block">
                            {post.author ? `${post.author.position}` : "Posición desconocido"}
                        </p>
                        <p class="text-gray-900 font-semibold text-xs sm:text-sm truncate w-full">
                            {post.author ? `${post.author.fullName}` : "Autor desconocido"}
                        </p>
                        <p class="text-gray-500 text-xs truncate w-full">{readingTimeText}</p>
                    </div>
                </div>
            </div>

            <!-- Breadcrumbs en esquina inferior derecha -->
            <div class="absolute bottom-4 right-4 max-w-[50%] sm:max-w-none">
                <Breadcrumb className="px-2 sm:px-3 py-1 text-xs sm:text-sm" client:load>
                    <BreadcrumbList className="flex-nowrap">
                        <BreadcrumbItem>
                            <BreadcrumbLink href="/" className="whitespace-nowrap">Inicio</BreadcrumbLink>
                        </BreadcrumbItem>
                        <BreadcrumbSeparator className="hidden sm:inline"></BreadcrumbSeparator>
                        <BreadcrumbItem className="hidden sm:block">
                            <BreadcrumbLink href="/boletines" className="whitespace-nowrap">Boletines</BreadcrumbLink>
                        </BreadcrumbItem>
                        <BreadcrumbSeparator></BreadcrumbSeparator>
                        <BreadcrumbItem className="min-w-0 flex-1">
                            <BreadcrumbPage className="truncate max-w-full inline-block" title={post.title}>
                                {post.title}
                            </BreadcrumbPage>
                        </BreadcrumbItem>
                    </BreadcrumbList>
                </Breadcrumb>
            </div>
        </section>

        <article
            class="prose prose-xl prose-h1:text-3xl prose-h2:text-2xl prose-h3:text-xl prose-h4:text-lg prose-a:no-underline hover:prose-a:underline prose-th:text-[17px] prose-td:text-[17px] prose-headings:text-neutral-900 prose-p:text-gray-700 prose-p:text-[17px] prose-li:text-[17px] pb-32 pt-10"
            set:html={htmlContent}
        ></article>
    </main>
</BlogLayout>